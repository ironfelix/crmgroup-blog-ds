"""
SEO Content Plan Generator ‚Äî crmgroup.ru / emailsoldiers.ru
============================================================
–ö–∞—á–∞–µ—Ç –í–°–ï –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏–∑ keys.so,
–¥–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Å–µ–º–∞–Ω—Ç–∏–∫—É –∏–∑ seo-keywords.md,
–∫–ª–∞—Å—Ç–µ—Ä–∏–∑—É–µ—Ç –ø–æ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å—Ç–æ–ª–ø–∞–º (pillar pages),
–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≠–ö–°–ü–ï–†–¢–ù–´–ï –∑–∞–≥–æ–ª–æ–≤–∫–∏ 2026 –≥–æ–¥–∞.

–ó–∞–ø—É—Å–∫: python3 seo_content_plan.py
"""

import subprocess, json, time, re
import pandas as pd
import numpy as np
from pathlib import Path
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.cluster import AgglomerativeClustering
from sklearn.metrics.pairwise import cosine_similarity

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ù–ê–°–¢–†–û–ô–ö–ò
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

API_TOKEN   = "699db3c64d1f39.83781556faa89d06f13a4d55eeb785aa412a1007"
COOKIE_JAR  = "/tmp/keyso_cookies_local.txt"
BASE_URL    = "https://api.keys.so"
OUTPUT_DIR  = Path("/Users/ivanilin/Documents/ivanilin/01-crmgroup/seo_output")
SEO_KW_FILE = Path("/Users/ivanilin/Documents/ivanilin/01-crmgroup/seo-keywords.md")
OUTPUT_DIR.mkdir(exist_ok=True)

OWN_DOMAINS = ["emailsoldiers.ru", "crmgroup.ru"]

AGENCY_COMPETITORS = [
    "emailmatrix.ru", "outofcloud.ru", "wim.agency",
    "mailfit.ru", "inboxmarketing.ru", "dirservice.ru", "dau.agency",
]
PLATFORM_COMPETITORS = ["mindbox.ru", "retailcrm.ru", "retailrocket.ru"]
ALL_COMPETITORS = AGENCY_COMPETITORS + PLATFORM_COMPETITORS

# –¢—è–Ω–µ–º –º–Ω–æ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü ‚Äî —Ö–æ—Ç–∏–º –í–°–ï —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∫–ª—é—á–∏
MAX_PAGES_PER_DOMAIN = 12   # 12 √ó 100 = 1 200 –∫–ª—é—á–µ–π –º–∞–∫—Å –Ω–∞ –¥–æ–º–µ–Ω
MIN_WS = 30                  # —É–±–∏—Ä–∞–µ–º —Å–æ–≤—Å–µ–º –º—É—Å–æ—Ä —Å —á–∞—Å—Ç–æ—Ç–æ–π < 30

# –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –∫–ª—é—á–∏ —Ö–æ—Ç—å –∫–∞–∫-—Ç–æ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–∞—à–µ–π –Ω–∏—à–µ–π
RELEVANCE_RE = re.compile(
    r"email|—Ä–∞—Å—Å—ã–ª–∫|–ø–∏—Å—å–º|newsletter|crm|—Å—Ä–º|–º–∞—Ä–∫–µ—Ç–∏–Ω–≥|marketing|"
    r"—Ç—Ä–∏–≥–≥–µ—Ä|–∞–≤—Ç–æ–º–∞—Ç|–ª–æ—è–ª–Ω|loyalty|–±–æ–Ω—É—Å|cashback|–∫—ç—à–±—ç–∫|"
    r"retention|—É–¥–µ—Ä–∂–∞–Ω|—Å–µ–≥–º–µ–Ω—Ç–∞—Ü|–ø–µ—Ä—Å–æ–Ω–∞–ª|–ø–æ–¥–ø–∏—Å—á–∏–∫|–ø–æ–¥–ø–∏—Å–∫|"
    r"–º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä|push|–ø—É—à|\bsms\b|—Å–º—Å|whatsapp|–≤–æ—Ç—Å–∞–ø|"
    r"cdp|–æ–º–Ω–∏|omni|open.?rate|–∫–ª–∏–∫–∞–±–µ–ª—å–Ω|–¥–æ—Å—Ç–∞–≤–ª—è–µ–º|"
    r"–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏|–ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–¥–∞–∂|customer.*journey|cjm|"
    r"–¥–∏—Ä–µ–∫—Ç.–º–∞—Ä–∫–µ—Ç–∏–Ω–≥|direct.market|rfm|ltv|–∫–ª–∏–µ–Ω—Ç—Å–∫",
    re.I
)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# KEYS.SO API CLIENT
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

class KeysSoAPI:
    def __init__(self, token: str):
        self.token = token
        self._calls = []
        self._warmup()

    def _warmup(self):
        subprocess.run([
            "curl", "-s", "-c", COOKIE_JAR, "-b", COOKIE_JAR,
            "-H", f"X-Keyso-TOKEN: {self.token}",
            f"{BASE_URL}/report/simple/domain_dashboard?domain=crmgroup.ru"
        ], capture_output=True, text=True, timeout=15)
        time.sleep(1)

    def _rate_limit(self):
        now = time.time()
        self._calls = [t for t in self._calls if now - t < 10]
        if len(self._calls) >= 9:
            wait = 10 - (now - self._calls[0]) + 0.2
            if wait > 0:
                print(f"    ‚è≥ rate limit {wait:.1f}s...", flush=True)
                time.sleep(wait)
        self._calls.append(time.time())

    def _get_raw(self, endpoint: str, params: dict, retries=4) -> dict:
        self._rate_limit()
        qs = "&".join(f"{k}={v}" for k, v in params.items())
        url = f"{BASE_URL}/{endpoint.lstrip('/')}?{qs}"
        for attempt in range(retries):
            r = subprocess.run([
                "curl", "-s", "-c", COOKIE_JAR, "-b", COOKIE_JAR,
                "-H", f"X-Keyso-TOKEN: {self.token}",
                "-H", "Accept: application/json",
                "-H", "User-Agent: Mozilla/5.0",
                url
            ], capture_output=True, text=True, timeout=30)
            body = r.stdout.strip()
            if not body:
                wait = (attempt + 1) * 5
                print(f"    ‚ö†Ô∏è  empty ({attempt+1}/{retries}), wait {wait}s...", flush=True)
                time.sleep(wait)
                self._warmup()
                continue
            try:
                data = json.loads(body)
            except json.JSONDecodeError:
                print(f"    ‚ö†Ô∏è  bad JSON: {body[:100]}", flush=True)
                time.sleep(5)
                continue
            if isinstance(data, dict) and data.get("code") == 202:
                wait = 35 if attempt == 0 else 65
                print(f"    ‚è≥ preparing report ({attempt+1}/{retries}), wait {wait}s...", flush=True)
                time.sleep(wait)
                continue
            return data
        return {}

    def get_organic_page(self, domain: str, page: int) -> list[dict]:
        data = self._get_raw("report/simple/organic/keywords", {
            "domain": domain, "base": "ru",
            "current_page": page, "per_page": 100,
        })
        return data.get("data", [])

    def get_all_organic(self, domain: str) -> list[dict]:
        all_kws = []
        for p in range(1, MAX_PAGES_PER_DOMAIN + 1):
            print(f"    page {p}...", end=" ", flush=True)
            items = self.get_organic_page(domain, p)
            if not items:
                print("done")
                break
            all_kws.extend(items)
            print(f"{len(items)} kws", flush=True)
            if len(items) < 100:
                break
            time.sleep(0.3)
        return all_kws


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ï –°–¢–û–õ–ü–´ (PILLARS)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ö–∞–∂–¥—ã–π —Å—Ç–æ–ª–ø = –æ–¥–∏–Ω hub-page + –Ω–∞–±–æ—Ä spoke-—Å—Ç–∞—Ç–µ–π
# –ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω: –ø–µ—Ä–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ–±–µ–∂–¥–∞–µ—Ç

PILLARS = [
    ("–ü—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏",
     r"–ª–æ—è–ª–Ω|loyalty|–ø—Ä–æ–≥—Ä–∞–º–º–∞.–ª–æ—è–ª|–±–æ–Ω—É—Å–Ω|cashback|–∫—ç—à–±—ç–∫|–∫–µ—à–±—ç–∫|club.card"),
    ("–£–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ / Retention",
     r"—É–¥–µ—Ä–∂–∞–Ω|retention|–ø–æ–≤—Ç–æ—Ä–Ω.–ø—Ä–æ–¥–∞–∂|–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ.–ø—Ä–æ–¥–∞–∂|churn|–æ—Ç—Ç–æ–∫|ltv|lifetime"),
    ("CRM-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥",
     r"\bcrm\b|—Å—Ä–º.–º–∞—Ä–∫–µ—Ç–∏–Ω–≥|crm.–º–∞—Ä–∫–µ—Ç–∏–Ω–≥|customer.journey|cjm\b|–∫–ª–∏–µ–Ω—Ç—Å–∫|–∫–∞—Ä—Ç–∞.–∫–ª–∏–µ–Ω—Ç|–ø—É—Ç—å.–∫–ª–∏–µ–Ω—Ç"),
    ("–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã",
     r"—Ç—Ä–∏–≥–≥–µ—Ä|–∞–≤—Ç–æ–º–∞—Ç.—Ä–∞—Å—Å—ã–ª–∫|–∞–≤—Ç–æ–º–∞—Ç–∏–∑|welcome.—Å–µ—Ä–∏—è|–±—Ä–æ—à–µ–Ω.–∫–æ—Ä–∑–∏–Ω|—Å—Ü–µ–Ω–∞—Ä–∏|workflow|—Ü–µ–ø–æ—á–∫|–∫—É—Ä—Å.*–∞–≤—Ç–æ–º–∞—Ç|–∞–≤—Ç–æ–º–∞—Ç.*–∫—É—Ä—Å"),
    ("Email-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ (—Å—Ç—Ä–∞—Ç–µ–≥–∏—è / —É—Å–ª—É–≥–∏)",
     r"email.–º–∞—Ä–∫–µ—Ç–∏–Ω–≥|–µ–º–µ–π–ª.–º–∞—Ä–∫–µ—Ç–∏–Ω–≥|—Å—Ç—Ä–∞—Ç–µ–≥–∏—è.—Ä–∞—Å—Å—ã–ª–∫"),
    ("Email-—Ä–∞—Å—Å—ã–ª–∫–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ / –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã)",
     r"—Ä–∞—Å—Å—ã–ª–∫|–µ–º–µ–π–ª.—Ä–∞—Å—Å—ã–ª–∫|email.—Ä–∞—Å—Å—ã–ª–∫|—Å–æ–∑–¥–∞—Ç—å.—Ä–∞—Å—Å—ã–ª–∫|–æ—Ç–ø—Ä–∞–≤|—à–∞–±–ª–æ–Ω.–ø–∏—Å—å–º|–≤–µ—Ä—Å—Ç–∫.–ø–∏—Å—å–º"
     r"|\bemail\b|\b–µ–º–µ–π–ª\b|\be.?mail\b|–ø–∏—Å—å–º"),
    ("–û–º–Ω–∏–∫–∞–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã",
     r"–º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä|push|–ø—É—à|\bsms\b|—Å–º—Å|whatsapp|–≤–æ—Ç—Å–∞–ø|–æ–º–Ω–∏|viber|–≤–∞–π–±–µ—Ä"),
    ("–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è",
     r"–ø–µ—Ä—Å–æ–Ω–∞–ª|—Å–µ–≥–º–µ–Ω—Ç–∞—Ü|rfm|cdp|—Ä–µ–∫–æ–º–µ–Ω–¥|—Ü–µ–ª–µ–≤—ã–µ.–≥—Ä—É–ø–ø—ã"),
    ("–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏",
     r"open.rate|–∫–ª–∏–∫–∞–±–µ–ª—å–Ω|ctr|or\b|–º–µ—Ç—Ä–∏–∫|–∞–Ω–∞–ª–∏—Ç–∏–∫|–∫–æ–Ω–≤–µ—Ä—Å–∏.–ø–∏—Å—å–º|a.b.—Ç–µ—Å—Ç|–¥–æ—Å—Ç–∞–≤–ª—è–µ–º"),
    ("CRM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç",
     r"crm.–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥|crm.—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç|retention.–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥"),
    # –®–∏—Ä–æ–∫–∏–µ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—Ç–æ–ª–ø, –Ω–µ ¬´–ü—Ä–æ—á–µ–µ¬ª
    ("Digital-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ (—à–∏—Ä–æ–∫–∏–µ —Ç–µ–º—ã)",
     r"–º–∞—Ä–∫–µ—Ç–∏–Ω–≥|marketing|digital|–¥–∏–¥–∂–∏—Ç–∞–ª|–ø–∏–∞—Ä|pr.–∞–≥–µ–Ω—Ç|smm|–∫–æ–Ω—Ç–µ–Ω—Ç.–ø–ª–∞–Ω|–≤–æ—Ä–æ–Ω–∫–∞.–ø—Ä–æ–¥–∞–∂|–ª–∏–¥.–º–∞–≥–Ω–∏—Ç|–ª–∏–¥–≥–µ–Ω"),
]

def classify_pillar(word: str) -> str:
    w = word.lower()
    for name, pattern in PILLARS:
        if re.search(pattern, w):
            return name
    return "–ü—Ä–æ—á–µ–µ"


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –¢–ò–ü –ö–û–ù–¢–ï–ù–¢–ê
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

CONTENT_TYPES = {
    # –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π ‚Üí –ø–æ—Å–∞–¥–æ—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    "landing": [
        r"–∞–≥–µ–Ω—Ç—Å—Ç–≤–æ|–∑–∞–∫–∞–∑–∞—Ç—å|–∑–∞–∫–∞–∑|–ø–æ–¥ –∫–ª—é—á|—Å—Ç–æ–∏–º–æ—Å—Ç—å.—Ä–∞—Å—Å—ã–ª–∫|—Ü–µ–Ω–∞.—Ä–∞—Å—Å—ã–ª–∫|"
        r"–∫—É–ø–∏—Ç—å.—Ä–∞—Å—Å—ã–ª–∫|—É—Å–ª—É–≥–∏.email|—É—Å–ª—É–≥–∏.crm|–∞—É—Ç—Å–æ—Ä—Å|–Ω–∞–Ω—è—Ç—å|—Å–∫–æ–ª—å–∫–æ.—Å—Ç–æ–∏—Ç",
    ],
    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è/—Ç–µ—Ä–º–∏–Ω—ã ‚Üí –≥–ª–æ—Å—Å–∞—Ä–∏–π
    "glossary": [
        r"—á—Ç–æ.—Ç–∞–∫–æ–µ|—á—Ç–æ.—ç—Ç–æ|—ç—Ç–æ.–ø—Ä–æ—Å—Ç—ã–º–∏|—Ç–µ—Ä–º–∏–Ω|–æ–ø—Ä–µ–¥–µ–ª–µ–Ω|–ø–æ–Ω—è—Ç–∏–µ|"
        r"–∑–Ω–∞—á–∏—Ç|—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫|–∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä",
    ],
    # –î–∞–Ω–Ω—ã–µ, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è ‚Üí emailsoldiers.ru/research
    "research": [
        r"—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫|–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω|–±–µ–Ω—á–º–∞—Ä–∫|benchmark|—Å—Ä–µ–¥–Ω.*or|—Å—Ä–µ–¥–Ω.*ctr|"
        r"–∏–Ω–¥–µ–∫—Å|–¥–∞–Ω–Ω—ã–µ.–ø–æ|—Ä—ã–Ω–æ–∫.*email|—Ç—Ä–µ–Ω–¥—ã.*—Ä–∞—Å—Å—ã–ª–æ–∫",
    ],
    # –ö–µ–π—Å (–µ—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç/–±—Ä–µ–Ω–¥)
    "case": [
        r"–∫–µ–π—Å|–ø—Ä–∏–º–µ—Ä.*–∫–æ–º–ø–∞–Ω–∏|–æ–ø—ã—Ç.*–±—Ä–µ–Ω–¥–∞|—Ä–µ–∑—É–ª—å—Ç–∞—Ç.*email|–∫–∞–∫.–º—ã",
    ],
}

def classify_content_type(word: str) -> str:
    w = word.lower()
    for ctype, patterns in CONTENT_TYPES.items():
        for p in patterns:
            if re.search(p, w):
                return ctype
    return "article"   # default = —ç–∫—Å–ø–µ—Ä—Ç–Ω–∞—è —Å—Ç–∞—Ç—å—è –≤ –±–ª–æ–≥

# –î–æ–º–µ–Ω –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
def suggest_domain(ctype: str, pillar: str) -> str:
    if ctype == "landing":
        return "crmgroup.ru"
    if ctype in ("research", "glossary"):
        return "emailsoldiers.ru"
    if ctype == "case":
        return "crmgroup.ru"
    # article: –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç–æ–ª–ø–∞
    if pillar in ("CRM-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥", "–ü—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏", "–£–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ / Retention"):
        return "crmgroup.ru"  # –Ω–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
    return "emailsoldiers.ru"

# URL slug
def suggest_slug(pillar: str, ctype: str) -> str:
    PILLAR_SLUGS = {
        "–ü—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏":             "loyalty-programs",
        "–£–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ / Retention":   "retention-marketing",
        "CRM-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥":                    "crm-marketing",
        "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã":         "email-automation",
        "Email-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ (—Å—Ç—Ä–∞—Ç–µ–≥–∏—è / —É—Å–ª—É–≥–∏)": "email-marketing",
        "Email-—Ä–∞—Å—Å—ã–ª–∫–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ / –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã)": "email-campaigns",
        "–û–º–Ω–∏–∫–∞–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã":    "omnichannel",
        "–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è":     "personalization",
        "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏":              "email-analytics",
        "CRM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç":                   "crm-specialist",
        "–ü—Ä–æ—á–µ–µ":                           "other",
    }
    slug = PILLAR_SLUGS.get(pillar, "other")
    prefix = {
        "landing":  "/services/",
        "glossary": "/glossary/",
        "research": "/research/",
        "case":     "/cases/",
        "article":  "/blog/",
    }.get(ctype, "/blog/")
    return prefix + slug


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –≠–ö–°–ü–ï–†–¢–ù–´–ï –ó–ê–ì–û–õ–û–í–ö–ò
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ü—Ä–∏–Ω—Ü–∏–ø: –∑–∞–≥–æ–ª–æ–≤–æ–∫ = –ø–æ–ª—å–∑–∞ –¥–ª—è —á–∏—Ç–∞—Ç–µ–ª—è, –∞ –Ω–µ –Ω–∞–±–æ—Ä –∫–ª—é—á–µ–π
# –ù–ï –¥–µ–ª–∞–µ–º: "X: –ø–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ 2026"
# –ù–ï –¥–µ–ª–∞–µ–º: "–ó–∞–∫–∞–∑–∞—Ç—å X: –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ CRM-group"
# –î–ï–õ–ê–ï–ú:    –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å, –∏–Ω—Å–∞–π—Ç, —Ü–∏—Ñ—Ä—É, —Ä–µ–∑—É–ª—å—Ç–∞—Ç

PILLAR_EXPERT_TITLES = {
    "–ü—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏": {
        "article":  [
            "–ü—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –≤ e-commerce: 5 –º–µ—Ö–∞–Ω–∏–∫ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏",
            "–ö–∞–∫ –±–æ–Ω—É—Å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ LTV –∫–ª–∏–µ–Ω—Ç–∞: —Ä–∞–∑–±–æ—Ä —Å —Ü–∏—Ñ—Ä–∞–º–∏",
            "–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä–∏—Ç–µ–π–ª–∞: —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å –∏ —á–µ–≥–æ –∏–∑–±–µ–≥–∞—Ç—å",
            "–ö—ç—à–±—ç–∫ vs –±–∞–ª–ª—ã: –∫–∞–∫–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª—É—á—à–µ",
        ],
        "glossary": "–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ ‚Äî —á—Ç–æ —ç—Ç–æ, –≤–∏–¥—ã –∏ –∫–∞–∫ –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â—É—é",
        "landing":  "–ü—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ ‚Äî –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è",
        "research": "–ü—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –≤ –†–æ—Å—Å–∏–∏: —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ 2026",
    },
    "–£–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ / Retention": {
        "article":  [
            "Retention-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥: –ø–æ—á–µ–º—É —É–¥–µ—Ä–∂–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –¥–µ—à–µ–≤–ª–µ, —á–µ–º –ø—Ä–∏–≤–ª–µ—á—å –Ω–æ–≤–æ–≥–æ",
            "–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏: 6 –º–µ—Ö–∞–Ω–∏–∫ –∫–æ—Ç–æ—Ä—ã–µ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —É –∫–ª–∏–µ–Ω—Ç–æ–≤",
            "–ö–∞–∫ —Å—á–∏—Ç–∞—Ç—å Retention Rate –∏ —á—Ç–æ —Å –Ω–∏–º –¥–µ–ª–∞—Ç—å",
            "–û—Ç—Ç–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ (churn): –∫–∞–∫ –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ email",
        ],
        "glossary": "Retention Rate ‚Äî —á—Ç–æ —ç—Ç–æ, –∫–∞–∫ —Å—á–∏—Ç–∞—Ç—å –∏ –∫–∞–∫ —É–ª—É—á—à–∏—Ç—å",
        "landing":  "Retention-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥: –∫–∞–∫ –º—ã –≤—ã—Å—Ç—Ä–∞–∏–≤–∞–µ–º —É–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤",
        "research": "–£–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –†–æ—Å—Å–∏–∏: –±–µ–Ω—á–º–∞—Ä–∫–∏ –∏ —Ç—Ä–µ–Ω–¥—ã 2026",
    },
    "CRM-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥": {
        "article":  [
            "CRM-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥: –∫–∞–∫ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –±–∞–∑—É –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥",
            "CRM-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ vs email-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥: –≤ —á—ë–º —Ä–∞–∑–Ω–∏—Ü–∞ –∏ —á—Ç–æ –≤—ã–±—Ä–∞—Ç—å",
            "CRM-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Å –Ω—É–ª—è: –∫–∞–∫ –º—ã –≤—ã—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º—É –∑–∞ 3 –º–µ—Å—è—Ü–∞",
            "–ú–µ—Ç—Ä–∏–∫–∏ CRM-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞: —á—Ç–æ –∏–∑–º–µ—Ä—è—Ç—å –∏ –∫–∞–∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å",
        ],
        "glossary": "CRM-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ ‚Äî —á—Ç–æ —ç—Ç–æ –∏ —á–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ CRM",
        "landing":  "CRM-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ ‚Äî —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ CRM-group",
        "research": "CRM-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –≤ –†–æ—Å—Å–∏–∏: –∫–∞–∫ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –±–∞–∑–æ–π –≤ 2026",
    },
    "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã": {
        "article":  [
            "–¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏: 8 —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏—è–º–∏",
            "Welcome-—Å–µ—Ä–∏—è: –∫–∞–∫ –ø–µ—Ä–≤—ã–µ 7 –ø–∏—Å–µ–º –≤–ª–∏—è—é—Ç –Ω–∞ LTV",
            "–ë—Ä–æ—à–µ–Ω–Ω–∞—è –∫–æ—Ä–∑–∏–Ω–∞: –∫–∞–∫ –º—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 18‚Äì25% –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ email",
            "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è email-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞: —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å –∏ –∫–∞–∫ –Ω–µ —É—Å–ª–æ–∂–Ω–∏—Ç—å",
        ],
        "glossary": "–¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏ ‚Äî —á—Ç–æ —ç—Ç–æ, –≤–∏–¥—ã –∏ –∫–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å",
        "landing":  "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è email-—Ä–∞—Å—Å—ã–ª–æ–∫ ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –ø–æ–¥ –∫–ª—é—á",
        "research": "–¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤ —Ä–æ—Å—Å–∏–π—Å–∫–æ–º e-commerce: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ 2026",
    },
    "Email-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ (—Å—Ç—Ä–∞—Ç–µ–≥–∏—è / —É—Å–ª—É–≥–∏)": {
        "article":  [
            "Email-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è —Ä–∏—Ç–µ–π–ª–∞: —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ 2026",
            "–ö–∞–∫ –∞—É–¥–∏—Ç email-–∫–∞–Ω–∞–ª–∞ –ø–æ–º–æ–≥ –∫–ª–∏–µ–Ω—Ç—É –≤—ã—Ä–∞—Å—Ç–∏ –Ω–∞ 40% –∑–∞ –∫–≤–∞—Ä—Ç–∞–ª",
            "Email-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –¥–ª—è b2b: —á–µ–º –æ–Ω –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç b2c –∏ –∫–∞–∫ –µ–≥–æ —Å—Ç—Ä–æ–∏—Ç—å",
            "–ü–æ—á–µ–º—É email-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –¥–∞—ë—Ç —Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π ROI",
        ],
        "glossary": "Email-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ ‚Äî —á—Ç–æ —ç—Ç–æ, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å",
        "landing":  "Email-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ ‚Äî –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ CRM-group",
        "research": "–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å email-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ –≤ –†–æ—Å—Å–∏–∏: –±–µ–Ω—á–º–∞—Ä–∫–∏ 2026",
    },
    "Email-—Ä–∞—Å—Å—ã–ª–∫–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ / –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã)": {
        "article":  [
            "–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å email-—Ä–∞—Å—Å—ã–ª–∫—É –∫–æ—Ç–æ—Ä—É—é –æ—Ç–∫—Ä—ã–≤–∞—é—Ç: –ø—Ä–∞–∫—Ç–∏–∫–∞ –∏ –ø—Ä–∏–º–µ—Ä—ã",
            "–í–µ—Ä—Å—Ç–∫–∞ –ø–∏—Å–µ–º: —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∫–∞–∫ –∏—Ö –∏–∑–±–µ–∂–∞—Ç—å",
            "–®–∞–±–ª–æ–Ω—ã email-—Ä–∞—Å—Å—ã–ª–æ–∫: –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –∞ –∫–æ–≥–¥–∞ —Å–¥–µ–ª–∞—Ç—å —Å –Ω—É–ª—è",
            "–ö–∞–∫ —É–≤–µ–ª–∏—á–∏—Ç—å open rate —Å 15% –¥–æ 28%: —Ä–∞–∑–±–æ—Ä –Ω–∞—à–∏—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤",
        ],
        "glossary": "Open Rate ‚Äî —á—Ç–æ —ç—Ç–æ, –Ω–æ—Ä–º–∞ –¥–ª—è –≤–∞—à–µ–π –Ω–∏—à–∏ –∏ –∫–∞–∫ —É–ª—É—á—à–∏—Ç—å",
        "landing":  "–°–æ–∑–¥–∞–Ω–∏–µ email-—Ä–∞—Å—Å—ã–ª–æ–∫ ‚Äî —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –ø–æ–¥ –∫–ª—é—á",
        "research": "Open Rate –∏ CTR –≤ –†–æ—Å—Å–∏–∏ 2026: –±–µ–Ω—á–º–∞—Ä–∫–∏ –ø–æ –æ—Ç—Ä–∞—Å–ª—è–º",
    },
    "–û–º–Ω–∏–∫–∞–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã": {
        "article":  [
            "–û–º–Ω–∏–∫–∞–Ω–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏: –∫–æ–≥–¥–∞ email + SMS + push —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ",
            "WhatsApp –¥–ª—è –±–∏–∑–Ω–µ—Å–∞: –∫–æ–≥–¥–∞ —Å—Ç–æ–∏—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å –∫ CRM-–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è–º",
            "Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è vs email: —á—Ç–æ –≤—ã–±—Ä–∞—Ç—å –∏ –∫–∞–∫ —Å–æ–≤–º–µ—Å—Ç–∏—Ç—å",
        ],
        "glossary": "–û–º–Ω–∏–∫–∞–Ω–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ ‚Äî —á—Ç–æ —ç—Ç–æ –∏ –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –≤ –ø—Ä–∞–∫—Ç–∏–∫–µ",
        "landing":  "–û–º–Ω–∏–∫–∞–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è",
        "research": "–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã –≤ CRM-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥–µ: —Ç—Ä–µ–Ω–¥—ã –∏ –¥–∞–Ω–Ω—ã–µ 2026",
    },
    "–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è": {
        "article":  [
            "–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –±–∞–∑—ã: 5 –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ –≤–ª–∏—è—é—Ç –Ω–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏—é",
            "RFM-–∞–Ω–∞–ª–∏–∑: –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —á—Ç–æ —Å–ª–∞—Ç—å –∫–∞–∂–¥–æ–º—É —Å–µ–≥–º–µ–Ω—Ç—É",
            "–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –≤ email: –æ—Ç –∏–º–µ–Ω–∏ –≤ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–∏ –¥–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Ç–æ–≤–∞—Ä–æ–≤",
        ],
        "glossary": "RFM-–∞–Ω–∞–ª–∏–∑ ‚Äî —á—Ç–æ —ç—Ç–æ –∏ –∫–∞–∫ —Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑—É –∑–∞ 1 —á–∞—Å",
        "landing":  "–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫ ‚Äî —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã –ø–æ–¥ –∫–ª—é—á",
        "research": "–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –≤ email-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥–µ: —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫–æ–º–ø–∞–Ω–∏–∏ –≤ 2026",
    },
    "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏": {
        "article":  [
            "–ö–∞–∫ —Å—á–∏—Ç–∞—Ç—å ROI email-–∫–∞–Ω–∞–ª–∞: —Ñ–æ—Ä–º—É–ª–∞ –∏ —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä",
            "A/B —Ç–µ—Å—Ç—ã –≤ —Ä–∞—Å—Å—ã–ª–∫–∞—Ö: —á—Ç–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –∫–∞–∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã",
            "Email-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞: 7 –º–µ—Ç—Ä–∏–∫ –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é",
        ],
        "glossary": "CTR –≤ email ‚Äî —á—Ç–æ —ç—Ç–æ, –Ω–æ—Ä–º–∞ –∏ –∫–∞–∫ —É–ª—É—á—à–∏—Ç—å",
        "landing":  "Email-–∞—É–¥–∏—Ç ‚Äî —Ä–∞–∑–±–æ—Ä –≤–∞—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞ –∏ –ø–ª–∞–Ω —Ä–æ—Å—Ç–∞",
        "research": "Email-–º–µ—Ç—Ä–∏–∫–∏ –≤ –†–æ—Å—Å–∏–∏ 2026: —Å—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –æ—Ç—Ä–∞—Å–ª—è–º",
    },
    "CRM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç": {
        "article":  [
            "CRM-–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥: –∫—Ç–æ —ç—Ç–æ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –∏ –∫–æ–≥–¥–∞ –Ω—É–∂–µ–Ω –≤–∞—à–µ–º—É –±–∏–∑–Ω–µ—Å—É",
            "–ò–Ω—Ö–∞—É—Å vs –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ: —á—Ç–æ –≤—ã–≥–æ–¥–Ω–µ–µ –¥–ª—è CRM-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞",
        ],
        "glossary": "CRM-–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥ ‚Äî —á—Ç–æ —ç—Ç–æ –∑–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –∏ —á—Ç–æ –æ–Ω –¥–µ–ª–∞–µ—Ç",
        "landing":  "CRM-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –Ω–∞ –∞—É—Ç—Å–æ—Ä—Å–µ ‚Äî –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ CRM-group",
        "research": "–†—ã–Ω–æ–∫ CRM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –≤ –†–æ—Å—Å–∏–∏ 2026: –∑–∞—Ä–ø–ª–∞—Ç—ã –∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏",
    },
    "–ü—Ä–æ—á–µ–µ": {
        "article":  ["–ö–æ–Ω—Ç–µ–Ω—Ç-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –≤ CRM: –∫–∞–∫ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å SEO –∏ email"],
        "glossary": "{term} ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–µ",
        "landing":  "–£—Å–ª—É–≥–∏ CRM-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ ‚Äî –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ CRM-group",
        "research": "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ä—ã–Ω–∫–∞ CRM-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ –≤ –†–æ—Å—Å–∏–∏ 2026",
    },
}

_title_counters: dict = {}
_used_titles: set = set()

def _keyword_to_expert_title(kw: str, ctype: str) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —á–∏—Ç–∞–µ–º—ã–π —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–∑ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –∫–ª—é—á–∞."""
    kw = kw.strip()
    kw_cap = kw.capitalize()
    # –£–±–∏—Ä–∞–µ–º –º—É—Å–æ—Ä–Ω—ã–µ –ø—Ä–∏—Å—Ç–∞–≤–∫–∏
    kw_clean = re.sub(r"^(—á—Ç–æ —Ç–∞–∫–æ–µ |–∫–∞–∫ |–∑–∞—á–µ–º |–ø–æ—á–µ–º—É )", "", kw).strip().capitalize()

    if ctype == "glossary":
        return f"{kw_clean} ‚Äî —á—Ç–æ —ç—Ç–æ, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –≥–¥–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è"
    if ctype == "landing":
        return f"{kw_clean} –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ CRM-group"
    if ctype == "research":
        return f"{kw_clean} –≤ –†–æ—Å—Å–∏–∏ 2026: –¥–∞–Ω–Ω—ã–µ –∏ —Ç—Ä–µ–Ω–¥—ã"
    if ctype == "case":
        return f"–ö–µ–π—Å: –∫–∞–∫ {kw} –ø–æ–º–æ–≥ —É–≤–µ–ª–∏—á–∏—Ç—å –≤—ã—Ä—É—á–∫—É –∫–ª–∏–µ–Ω—Ç–∞"
    # article
    if re.search(r"^(—á—Ç–æ|–∫–∞–∫|–∑–∞—á–µ–º|–ø–æ—á–µ–º—É|–∫–æ–≥–¥–∞|—á–µ–º)", kw):
        return f"{kw_cap}: –æ—Ç–≤–µ—á–∞–µ–º –∏–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞"
    if re.search(r"–º–µ—Ç—Ä–∏–∫|–ø–æ–∫–∞–∑–∞—Ç–µ–ª|kpi|–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç|—Ñ–æ—Ä–º—É–ª", kw):
        return f"{kw_clean}: –∫–∞–∫ —Å—á–∏—Ç–∞—Ç—å –∏ –Ω–∞ —á—Ç–æ –≤–ª–∏—è–µ—Ç"
    if re.search(r"—Å–µ—Ä–≤–∏—Å|–ø–ª–∞—Ç—Ñ–æ—Ä–º|–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç|–ø—Ä–æ–≥—Ä–∞–º–º", kw):
        return f"{kw_clean}: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏ –∫–∞–∫ –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥ –∑–∞–¥–∞—á–∏ –±–∏–∑–Ω–µ—Å–∞"
    if re.search(r"–∞–≥–µ–Ω—Ç—Å—Ç–≤|–∫–æ–º–ø–∞–Ω–∏|—É—Å–ª—É–≥", kw):
        return f"{kw_clean}: –Ω–∞ —á—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–æ–¥—Ä—è–¥—á–∏–∫–∞"
    if re.search(r"–∫—É—Ä—Å|–æ–±—É—á–µ–Ω–∏|—à–∫–æ–ª", kw):
        return f"–ö–∞–∫ —Ä–∞–∑–≤–∏—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—É –≤ {kw_clean.lower()}: —Ä–µ—Å—É—Ä—Å—ã –∏ –ø—Ä–∞–∫—Ç–∏–∫–∞"
    if re.search(r"—Å—Ç—Ä–∞—Ç–µ–≥|–ø–ª–∞–Ω|–∫–æ–Ω—Ü–µ–ø—Ü", kw):
        return f"{kw_clean}: –ø–æ—à–∞–≥–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ –∏–∑ –Ω–∞—à–µ–π –ø—Ä–∞–∫—Ç–∏–∫–∏"
    if re.search(r"–ø—Ä–∏–º–µ—Ä|–∫–µ–π—Å|–æ–ø—ã—Ç", kw):
        return f"{kw_clean}: —Ä–∞–∑–±–æ—Ä —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞"
    return f"{kw_clean}: —Ä–∞–∑–±–æ—Ä —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏–∑ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤"


def generate_expert_title(pillar: str, ctype: str, cluster_name: str) -> str:
    titles = PILLAR_EXPERT_TITLES.get(pillar)

    # –î–ª—è ¬´–ü—Ä–æ—á–µ–µ¬ª –∏ ¬´Digital-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥¬ª ‚Äî –≤—Å–µ–≥–¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑ –∫–ª—é—á–∞
    if titles is None or pillar in ("–ü—Ä–æ—á–µ–µ", "Digital-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ (—à–∏—Ä–æ–∫–∏–µ —Ç–µ–º—ã)"):
        title = _keyword_to_expert_title(cluster_name, ctype)
        # –ï—Å–ª–∏ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º —É—Ç–æ—á–Ω–µ–Ω–∏–µ
        base = title
        suffix = 0
        while title in _used_titles:
            suffix += 1
            kw_part = cluster_name.split()[0].capitalize()
            title = f"{base} ({kw_part})"
        _used_titles.add(title)
        return title

    options = titles.get(ctype, titles.get("article", [cluster_name]))
    key = (pillar, ctype)
    idx = _title_counters.get(key, 0)

    if isinstance(options, list):
        # –ò—â–µ–º –ø–µ—Ä–≤—ã–π –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
        found = None
        for i in range(len(options)):
            candidate = options[(idx + i) % len(options)]
            if candidate not in _used_titles:
                found = candidate
                _title_counters[key] = (idx + i + 1)
                break
        if found is None:
            # –í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑ –∫–ª—é—á–∞
            found = _keyword_to_expert_title(cluster_name, ctype)
        title = found
    else:
        title = options

    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º {term} –µ—Å–ª–∏ –Ω—É–∂–µ–Ω placeholder
    if "{term}" in title:
        term = cluster_name.replace(" —ç—Ç–æ", "").replace("—á—Ç–æ —Ç–∞–∫–æ–µ ", "").strip().capitalize()
        title = title.replace("{term}", term)

    # –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
    base = title
    attempt = 0
    while title in _used_titles:
        attempt += 1
        kw_part = cluster_name.split()[0].capitalize()
        title = f"{base} ‚Äî {kw_part}"

    _used_titles.add(title)
    return title


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ü–ê–†–°–ò–ù–ì seo-keywords.md
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def parse_own_keywords(path: Path) -> list[dict]:
    """–ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ—Ä–∞–∑—ã –∏–∑ –ø–µ—Ä–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ + –∫–ª—é—á–∏ —Å —á–∞—Å—Ç–æ—Ç–∞–º–∏."""
    if not path.exists():
        print(f"  [!] –ù–µ –Ω–∞–π–¥–µ–Ω {path}")
        return []
    rows = []
    seen = set()
    with open(path) as f:
        for line in f:
            line = line.strip()
            if not line or line.startswith("#"):
                continue
            # –°—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ "keyword\tN" (—Å —á–∞—Å—Ç–æ—Ç–æ–π)
            parts = re.split(r"\t+", line)
            phrase = parts[0].strip().lower()
            if not phrase or phrase in ("—Ñ—Ä–∞–∑—ã", "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã", "–ø–ª–∞—Ç—Ñ–æ—Ä–º—ã"):
                continue
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–æ–º–µ–Ω—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (wim.agency, mindbox –∏ —Ç.–¥.)
            if re.search(r"\.(ru|agency|su|com|io|net)\b", phrase):
                continue
            freq = 0
            if len(parts) > 1:
                try:
                    freq = int(parts[1].replace(" ", "").replace("\xa0", ""))
                except ValueError:
                    pass
            if phrase not in seen:
                seen.add(phrase)
                rows.append({
                    "keyword":    phrase,
                    "ws":         freq,
                    "pos":        None,
                    "url":        "",
                    "source_domain": "own-seed",
                    "is_own":     True,
                })
    print(f"  –ò–∑ seo-keywords.md: {len(rows)} —Ñ—Ä–∞–∑")
    return rows


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ö–õ–ê–°–¢–ï–†–ò–ó–ê–¶–ò–Ø –≤–Ω—É—Ç—Ä–∏ —Å—Ç–æ–ª–ø–∞
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def cluster_pillar(words: list[str]) -> list[int]:
    if len(words) <= 2:
        return list(range(len(words)))
    vec = TfidfVectorizer(analyzer="char_wb", ngram_range=(2, 4), min_df=1)
    X = vec.fit_transform(words)
    sim = cosine_similarity(X)
    dist = (1 - sim).clip(0)
    n = max(1, min(12, int(np.sqrt(len(words)) / 1.8)))
    if n == 1:
        return [0] * len(words)
    model = AgglomerativeClustering(n_clusters=n, metric="precomputed", linkage="average")
    return model.fit_predict(dist).tolist()

def best_label_word(words: list[str], ws_list: list[float]) -> str:
    """–°–ª–æ–≤–æ —Å –Ω–∞–∏–±–æ–ª—å—à–µ–π —á–∞—Å—Ç–æ—Ç–æ–π –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ, –∏–ª–∏ —Å–∞–º–æ–µ –¥–ª–∏–Ω–Ω–æ–µ –µ—Å–ª–∏ –Ω–µ—Ç —á–∞—Å—Ç–æ—Ç."""
    if any(w > 0 for w in ws_list):
        idx = int(np.argmax(ws_list))
        return words[idx]
    return max(words, key=len)


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def pull_all_organic(api: KeysSoAPI) -> list[dict]:
    """–¢—è–Ω–µ–º –æ—Ä–≥–∞–Ω–∏–∫—É —É –≤—Å–µ—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤, —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏."""
    print("\nüì• –ö–∞—á–∞–µ–º –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤...")
    all_rows = []
    seen = set()
    for domain in ALL_COMPETITORS:
        print(f"\n  ‚Üí {domain}")
        is_platform = domain in PLATFORM_COMPETITORS
        try:
            kws = api.get_all_organic(domain)
        except Exception as e:
            print(f"    ‚ö†Ô∏è  {e}")
            continue
        added = 0
        for kw in kws:
            word = kw.get("word", "").lower().strip()
            ws = kw.get("ws", 0) or 0
            if ws < MIN_WS:
                continue
            if not RELEVANCE_RE.search(word):
                continue
            dedup_key = word
            seen_before = dedup_key in seen
            seen.add(dedup_key)
            all_rows.append({
                "keyword":        word,
                "ws":             ws,
                "pos":            kw.get("pos"),
                "url":            kw.get("url", ""),
                "source_domain":  domain,
                "is_platform":    is_platform,
                "is_own":         False,
                "seen_elsewhere": seen_before,
            })
            added += 1
        print(f"    –¥–æ–±–∞–≤–ª–µ–Ω–æ: {added} —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö")
    print(f"\n  –ò—Ç–æ–≥–æ (—Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏ –ø–æ —Ä–∞–∑–Ω—ã–º –¥–æ–º–µ–Ω–∞–º): {len(all_rows)}")
    return all_rows


def build_content_plan(all_rows: list[dict]) -> pd.DataFrame:
    """–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞."""
    if not all_rows:
        return pd.DataFrame()

    df = pd.DataFrame(all_rows)

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é
    df["pillar"]       = df["keyword"].apply(classify_pillar)
    df["content_type"] = df["keyword"].apply(classify_content_type)
    df["domain"]       = [suggest_domain(ct, p) for ct, p in zip(df["content_type"], df["pillar"])]

    # –£–±–∏—Ä–∞–µ–º —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ/—à–∏—Ä–æ–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã (1-2 —Å–ª–æ–≤–∞, WS > 100K)
    # ‚Äî –æ–Ω–∏ –Ω–µ –¥–∞—é—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç–∞—Ç—å—é, –ø—Ä–æ—Å—Ç–æ —à—É–º —Å –æ–≥—Ä–æ–º–Ω—ã–º –æ–±—ä—ë–º–æ–º
    def is_too_generic(row):
        words_n = len(str(row["keyword"]).split())
        return words_n <= 2 and (row["ws"] or 0) > 100_000

    mask_generic = df.apply(is_too_generic, axis=1)
    if mask_generic.sum():
        print(f"  –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ —Å–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: {mask_generic.sum()}")
    df = df[~mask_generic].copy()

    # –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º: –æ–¥–∏–Ω –∫–ª—é—á ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ–π
    # (–∫–ª—é—á –º–æ–≥ –ø—Ä–∏–π—Ç–∏ –æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤)
    agg = (
        df.groupby("keyword")
        .agg(
            ws              = ("ws", "max"),
            pillar          = ("pillar", "first"),
            content_type    = ("content_type", "first"),
            domain          = ("domain", "first"),
            competitor_count= ("source_domain", lambda x: len(set(x) - {"own-seed"})),
            competitors     = ("source_domain", lambda x: ", ".join(sorted(set(x) - {"own-seed"}))),
            is_own          = ("is_own", "any"),
            example_url     = ("url", lambda x: next((v for v in x if v), "")),
        )
        .reset_index()
    )

    print(f"\nüîë –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π: {len(agg)}")

    # –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ (—Å—Ç–æ–ª–ø √ó —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
    plan_rows = []
    all_kws_rows = []

    for (pillar, ctype), grp in agg.groupby(["pillar", "content_type"]):
        words  = grp["keyword"].tolist()
        ws_arr = grp["ws"].tolist()

        labels = cluster_pillar(words)

        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å—É–±–∫–ª–∞—Å—Ç–µ—Ä—É
        sub_groups: dict = {}
        for lbl, idx in zip(labels, grp.index):
            sub_groups.setdefault(lbl, []).append(idx)

        for lbl, idxs in sub_groups.items():
            sub = grp.loc[idxs]
            cluster_words = sub["keyword"].tolist()
            cluster_ws    = sub["ws"].tolist()
            best_word     = best_label_word(cluster_words, cluster_ws)
            expert_title  = generate_expert_title(pillar, ctype, best_word)
            domain        = suggest_domain(ctype, pillar)
            slug          = suggest_slug(pillar, ctype)
            n_comp        = int(sub["competitor_count"].max())
            total_ws      = int(sub["ws"].sum())

            priority = (
                "üî¥ –í—ã—Å–æ–∫–∏–π"   if n_comp >= 4 or total_ws >= 3000 else
                "üü° –°—Ä–µ–¥–Ω–∏–π"   if n_comp >= 2 or total_ws >= 500  else
                "üü¢ –ù–∏–∑–∫–∏–π"
            )

            plan_rows.append({
                "–°—Ç–æ–ª–ø (pillar)":       pillar,
                "–¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞":         {
                    "landing":  "–ü–æ—Å–∞–¥–æ—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞",
                    "article":  "–≠–∫—Å–ø–µ—Ä—Ç–Ω–∞—è —Å—Ç–∞—Ç—å—è",
                    "glossary": "–ì–ª–æ—Å—Å–∞—Ä–∏–π",
                    "case":     "–ö–µ–π—Å",
                    "research": "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ",
                }.get(ctype, ctype),
                "–î–æ–º–µ–Ω":               domain,
                "URL (—Ä–∞–∑–¥–µ–ª)":        slug,
                "–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏":    expert_title,
                "–ö–ª—é—á–µ–π –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ":   len(cluster_words),
                "Œ£ WS (—Å–ø—Ä–æ—Å)":        total_ws,
                "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤":         n_comp,
                "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç":           priority,
                "–ü—Ä–∏–º–µ—Ä URL –∫–æ–Ω–∫.":    sub["example_url"].iloc[0],
                "–ö–ª—é—á–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞":      " | ".join(sorted(cluster_words, key=lambda w: -cluster_ws[cluster_words.index(w)])),
            })

            for w, ws_val, comp in zip(sub["keyword"], sub["ws"], sub["competitor_count"]):
                all_kws_rows.append({
                    "–ö–ª—é—á":         w,
                    "WS":           ws_val,
                    "–°—Ç–æ–ª–ø":        pillar,
                    "–¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞": ctype,
                    "–î–æ–º–µ–Ω":        domain,
                    "–ó–∞–≥–æ–ª–æ–≤–æ–∫":    expert_title,
                    "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤":  comp,
                })

    plan_df = pd.DataFrame(plan_rows)
    plan_df = plan_df.sort_values(
        ["–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç", "Œ£ WS (—Å–ø—Ä–æ—Å)"],
        ascending=[True, False]
    )

    return plan_df, pd.DataFrame(all_kws_rows)


def save_excel(plan_df: pd.DataFrame, kws_df: pd.DataFrame):
    out = OUTPUT_DIR / "content_plan_2026.xlsx"

    # –°–≤–æ–¥–∫–∞ –ø–æ —Å—Ç–æ–ª–ø–∞–º
    pivot = (
        plan_df.groupby(["–°—Ç–æ–ª–ø (pillar)", "–¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞"])
        .agg(
            –°—Ç–∞—Ç–µ–π        = ("–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏", "count"),
            Œ£_WS          = ("Œ£ WS (—Å–ø—Ä–æ—Å)", "sum"),
            –í—ã—Å–æ–∫–∏–π_–ø—Ä–∏–æ—Ä = ("–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç", lambda x: (x == "üî¥ –í—ã—Å–æ–∫–∏–π").sum()),
        )
        .reset_index()
        .sort_values("Œ£_WS", ascending=False)
    )

    with pd.ExcelWriter(out, engine="openpyxl") as w:
        plan_df.to_excel(w, sheet_name="–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω", index=False)
        pivot.to_excel(w, sheet_name="–°–≤–æ–¥–∫–∞ –ø–æ —Å—Ç–æ–ª–ø–∞–º", index=False)
        kws_df.to_excel(w, sheet_name="–í—Å–µ –∫–ª—é—á–∏", index=False)

        for sheet_name, df_s in [
            ("–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω", plan_df),
            ("–°–≤–æ–¥–∫–∞ –ø–æ —Å—Ç–æ–ª–ø–∞–º", pivot),
            ("–í—Å–µ –∫–ª—é—á–∏", kws_df),
        ]:
            ws = w.sheets[sheet_name]
            for col in ws.columns:
                mx = max((len(str(c.value)) for c in col if c.value), default=10)
                ws.column_dimensions[col[0].column_letter].width = min(mx + 2, 70)

    print(f"\n‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {out}")
    return out


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# MAIN
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

if __name__ == "__main__":
    print("üöÄ SEO Content Plan Generator 2026", flush=True)
    print(f"   –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤: {len(ALL_COMPETITORS)}", flush=True)
    print(f"   –°—Ç—Ä–∞–Ω–∏—Ü –Ω–∞ –¥–æ–º–µ–Ω: {MAX_PAGES_PER_DOMAIN} (–º–∞–∫—Å {MAX_PAGES_PER_DOMAIN*100} –∫–ª—é—á–µ–π)", flush=True)

    api = KeysSoAPI(API_TOKEN)

    # 1. –°–≤–æ—è —Å–µ–º–∞–Ω—Ç–∏–∫–∞
    print("\nüìñ –ü–∞—Ä—Å–∏–º seo-keywords.md...", flush=True)
    own_rows = parse_own_keywords(SEO_KW_FILE)

    # 2. –û—Ä–≥–∞–Ω–∏–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    competitor_rows = pull_all_organic(api)

    # 3. –û–±—ä–µ–¥–∏–Ω—è–µ–º
    all_rows = competitor_rows + own_rows
    print(f"\nüî¢ –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π (—Å –¥—É–±–ª—è–º–∏): {len(all_rows)}", flush=True)

    # 4. –°—Ç—Ä–æ–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω
    plan_df, kws_df = build_content_plan(all_rows)

    print(f"\nüìã –ò—Ç–æ–≥–æ —Å—Ç–∞—Ç–µ–π/—Å—Ç—Ä–∞–Ω–∏—Ü –≤ –ø–ª–∞–Ω–µ: {len(plan_df)}", flush=True)
    print(f"   –ò–∑ –Ω–∏—Ö –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {(plan_df['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'] == 'üî¥ –í—ã—Å–æ–∫–∏–π').sum()}", flush=True)

    # 5. –ü—Ä–µ–≤—å—é
    print("\nüîù –¢–æ–ø-20 –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É + —Å–ø—Ä–æ—Å—É:")
    cols = ["–°—Ç–æ–ª–ø (pillar)", "–¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞", "–î–æ–º–µ–Ω", "–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏", "Œ£ WS (—Å–ø—Ä–æ—Å)", "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç"]
    print(plan_df[cols].head(20).to_string(index=False, max_colwidth=65))

    # 6. –°–æ—Ö—Ä–∞–Ω—è–µ–º
    save_excel(plan_df, kws_df)
